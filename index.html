<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Hippocampus Annotation Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-drop-area {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-drop-area.dragover {
            background-color: #e0f2fe;
            border-color: #0284c7;
        }
        #error-message, #loading-indicator {
            display: none;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .file-title-row td {
            border-top: 3px solid #e5e7eb; /* gray-200 */
            border-bottom: 1px solid #e5e7eb;
            background-color: #f9fafb; /* gray-50 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Collaborative Annotation Database</h1>
            <p class="mt-2 text-lg text-gray-600">Upload `.annot` files to automatically populate the shared database in real-time.</p>
            <div id="auth-status" class="mt-4 text-sm text-gray-500 bg-gray-200 inline-block px-3 py-1 rounded-full">
                Connecting...
            </div>
        </header>

        <main>
            <!-- File Upload Section -->
            <div id="file-upload-section" class="mb-8">
                <div id="file-drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-white shadow-sm">
                    <input type="file" id="file-input" multiple accept=".annot" class="hidden" disabled>
                    <label for="file-input" id="file-label" class="cursor-not-allowed opacity-50">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="mt-2 text-sm text-gray-600">
                            <span id="upload-text" class="font-semibold text-sky-600">Authenticate to upload</span> or drag and drop
                        </p>
                        <p class="text-xs text-gray-500">.annot files only</p>
                    </label>
                </div>
            </div>

            <!-- Messages and Loaders -->
            <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>
            <div id="loading-indicator" class="text-center py-8">
                <div class="spinner h-12 w-12 rounded-full border-4 border-gray-200 mx-auto"></div>
                <p class="mt-4 text-gray-600">Loading annotations from database...</p>
            </div>

            <!-- Data Table Section -->
            <div id="data-section" class="hidden">
                 <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                    <h2 class="text-2xl font-bold text-gray-900">Shared Annotation Database</h2>
                    <button id="export-csv" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors w-full md:w-auto">
                        Export All as CSV
                    </button>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                    <table id="results-table" class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploader ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Slice</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Side</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Annotation</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ci Score</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Score</th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be inserted here from Firestore -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Element References ---
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('file-input');
        const fileLabel = document.getElementById('file-label');
        const uploadText = document.getElementById('upload-text');
        const resultsTableBody = document.getElementById('results-body');
        const dataSection = document.getElementById('data-section');
        const exportBtn = document.getElementById('export-csv');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const authStatusDiv = document.getElementById('auth-status');

        let db, auth;
        let currentUserId = null;
        let allAnnotations = [];
        let unsubscribeFromAnnotations = null;

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig.apiKey) {
                    showError("Firebase configuration is missing. The application cannot connect to the database.");
                    return;
                }
                
                setLogLevel('Debug');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        authStatusDiv.innerHTML = `Connected as: <span class="font-semibold">${currentUserId}</span>`;
                        enableFileUpload();
                        await listenForAnnotations(appId);
                    } else {
                        authStatusDiv.textContent = 'Authenticating...';
                        try {
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (token) {
                                await signInWithCustomToken(auth, token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            showError("Could not authenticate with the server. Data cannot be saved or loaded.");
                            authStatusDiv.textContent = 'Authentication Failed';
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                showError("A critical error occurred while initializing the application.");
                loadingIndicator.style.display = 'none';
            }
        }

        // --- Firestore Data Handling ---
        async function listenForAnnotations(appId) {
            loadingIndicator.style.display = 'block';
            dataSection.classList.add('hidden');

            const annotationsCollectionPath = `/artifacts/${appId}/public/data/annotations`;
            const q = query(collection(db, annotationsCollectionPath));

            if (unsubscribeFromAnnotations) unsubscribeFromAnnotations();

            unsubscribeFromAnnotations = onSnapshot(q, (querySnapshot) => {
                allAnnotations = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable();
                loadingIndicator.style.display = 'none';
                dataSection.classList.remove('hidden');
            }, (error) => {
                console.error("Error fetching annotations:", error);
                showError("Failed to load data from the database. Please check your connection and refresh.");
                loadingIndicator.style.display = 'none';
            });
        }

        async function saveAnnotation(appId, annotationData) {
            const annotationsCollectionPath = `/artifacts/${appId}/public/data/annotations`;
            try {
                await addDoc(collection(db, annotationsCollectionPath), {
                    ...annotationData,
                    uploaderId: currentUserId,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error adding document: ", error);
                showError(`Failed to save annotation for ${annotationData.filename}.`);
            }
        }

        // --- Parsing Logic ---
        function parseAnnotFile(xmlContent) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlContent, "application/xml");
            if (xmlDoc.querySelector("parsererror")) throw new Error("XML parsing error.");

            const landmarkAnnotations = xmlDoc.querySelectorAll('folder[key^="Element"]');
            const annotations = [];
            let leftTotal = "N/A", rightTotal = "N/A", slicePosition = "N/A";

            const landmarkData = Array.from(landmarkAnnotations).map(folder => {
                const typeEntry = folder.querySelector('entry[key="Type"]');
                if (typeEntry?.getAttribute('value') === 'LandmarkAnnotation') {
                    const textEntry = folder.querySelector('entry[key="Text"]');
                    const posEntry = folder.querySelector('entry[key="Pos"]');
                    if (textEntry && posEntry) {
                        const posArray = posEntry.getAttribute('value').split(' ').map(Number);
                        return { text: textEntry.getAttribute('value'), pos: posArray[0], slice: posArray[2] };
                    }
                }
                return null;
            }).filter(Boolean);
            
            if(landmarkData.length > 0) {
                slicePosition = landmarkData[0].slice;
            }

            const leftTotalAnnotation = landmarkData.find(d => d.text.toLowerCase().includes('total') && d.pos < 400);
            if(leftTotalAnnotation) leftTotal = leftTotalAnnotation.text;

            const rightTotalAnnotation = landmarkData.find(d => d.text.toLowerCase().includes('total') && d.pos >= 400);
            if(rightTotalAnnotation) rightTotal = rightTotalAnnotation.text;

            landmarkData.forEach(({ text, pos }) => {
                if (text.toLowerCase().startsWith('total=')) return;

                const side = pos < 400 ? 'Left' : 'Right';
                const totalScore = side === 'Left' ? leftTotal : rightTotal;
                const ciMatch = text.match(/Ci=(\d+)/);
                const annotationMatch = text.match(/^(\d+)\./);
                const descriptionMatch = text.match(/\((.*)\)/);

                annotations.push({
                    slice: slicePosition,
                    side,
                    annotation: annotationMatch ? annotationMatch[1] : 'N/A',
                    ciScore: ciMatch ? ciMatch[1] : 'N/A',
                    description: descriptionMatch ? descriptionMatch[1] : text,
                    totalScore
                });
            });
            return annotations;
        }

        // --- Display Logic ---
        function renderTable() {
            resultsTableBody.innerHTML = '';
            if (allAnnotations.length === 0) return;

            const groupedByFile = allAnnotations.reduce((acc, curr) => {
                (acc[curr.filename] = acc[curr.filename] || []).push(curr);
                return acc;
            }, {});

            const sortedFilenames = Object.keys(groupedByFile).sort();

            sortedFilenames.forEach((filename) => {
                // Add the title row for the file
                const titleRow = document.createElement('tr');
                titleRow.classList.add('file-title-row');
                titleRow.innerHTML = `<td colspan="7" class="px-6 py-3 text-base font-bold text-gray-900">${filename}</td>`;
                resultsTableBody.appendChild(titleRow);

                const annotationsInFile = groupedByFile[filename];
                annotationsInFile.sort((a,b) => a.annotation - b.annotation);

                annotationsInFile.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" style="max-width: 150px;" title="${item.uploaderId}">${item.uploaderId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-700">${item.slice}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${item.side === 'Left' ? 'text-blue-600' : 'text-green-600'}">${item.side}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.annotation}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.ciScore}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.totalScore}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
            });
        }
        
        // --- UI and Event Handlers ---
        function enableFileUpload() {
            fileInput.disabled = false;
            fileLabel.classList.remove('cursor-not-allowed', 'opacity-50');
            uploadText.textContent = 'Click to upload';
        }

        fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); if (!fileInput.disabled) fileDropArea.classList.add('dragover'); });
        fileDropArea.addEventListener('dragleave', () => fileDropArea.classList.remove('dragover'));
        fileDropArea.addEventListener('drop', (e) => { e.preventDefault(); fileDropArea.classList.remove('dragover'); if (!fileInput.disabled) handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        async function handleFiles(files) {
            hideError();
            const annotFiles = Array.from(files).filter(file => file.name.endsWith('.annot'));
            if (annotFiles.length === 0) { showError("No .annot files were selected."); return; }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            for (const file of annotFiles) {
                try {
                    const fileContent = await file.text();
                    const parsedData = parseAnnotFile(fileContent);
                    for (const item of parsedData) {
                        await saveAnnotation(appId, { filename: file.name, ...item });
                    }
                } catch (error) {
                    console.error("Error processing file:", file.name, error);
                    showError(`Failed to parse and save ${file.name}. It might be corrupted or invalid.`);
                }
            }
        }

        function showError(message) { errorTextSpan.textContent = message; errorMessageDiv.style.display = 'block'; }
        function hideError() { errorMessageDiv.style.display = 'none'; }

        // --- CSV Export ---
        exportBtn.addEventListener('click', () => {
            if (allAnnotations.length === 0) { showError("No data to export."); return; }
            const headers = ['Uploader_ID', 'Filename', 'Slice', 'Side', 'Annotation', 'Ci_Score', 'Description', 'Total_Score'];
            
            // Sort data for export consistency
            allAnnotations.sort((a, b) => {
                if (a.filename < b.filename) return -1;
                if (a.filename > b.filename) return 1;
                return a.annotation - b.annotation;
            });

            const csvContent = [
                headers.join(','),
                ...allAnnotations.map(row => [
                    row.uploaderId || 'N/A',
                    row.filename,
                    row.slice,
                    row.side,
                    row.annotation,
                    row.ciScore,
                    `"${(row.description || '').replace(/"/g, '""')}"`,
                    `"${(row.totalScore || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'hippocampus_annotation_database.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- Start the application ---
        initializeFirebase();
    </script>
</body>
</html>
